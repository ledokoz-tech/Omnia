name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  test:
    name: Test (${{ matrix.os }}, ${{ matrix.compiler }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            compiler: gcc
            cc: gcc
            cxx: g++
          - os: ubuntu-latest
            compiler: clang
            cc: clang
            cxx: clang++
          # Windows
          - os: windows-latest
            compiler: msvc
            cc: cl
            cxx: cl
          # macOS
          - os: macos-latest
            compiler: clang
            cc: clang
            cxx: clang++

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgtk-3-dev \
          libwebkit2gtk-4.0-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          libasound2-dev \
          libxss1 \
          pkg-config

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake ninja

    - name: Configure CMake
      shell: bash
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          # Windows: Disable GUI dependencies since pkg-config is not available
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DBUILD_EXAMPLES=ON \
            -DBUILD_TESTS=ON \
            -DENABLE_GUI=OFF
        else
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DBUILD_EXAMPLES=ON \
            -DBUILD_TESTS=ON
        fi

    - name: Build project
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

    - name: Run tests
      run: ctest --test-dir build --config ${{ env.BUILD_TYPE }} --output-on-failure

  # Code Quality checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgtk-3-dev \
          clang-tidy \
          cppcheck

    - name: Configure CMake
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DBUILD_EXAMPLES=OFF \
          -DBUILD_TESTS=OFF

    - name: Run clang-tidy
      run: |
        find src include -name "*.cpp" -o -name "*.hpp" | \
        xargs clang-tidy --config-file=.clang-tidy --quiet

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --std=c++17 --language=c++ \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=unmatchedSuppression \
          --inline-suppr \
          src/ include/ examples/

    - name: Check documentation
      run: |
        # Check if all public headers have basic documentation
        find include -name "*.hpp" -exec grep -L "/\*\*" {} \; | wc -l | xargs test 0 -eq

  # Cross-platform compilation check (disabled for now)
  # cross-compile:
  #   name: Cross-compile (${{ matrix.target }})
  #   runs-on: ubuntu-latest

  # Release checks (only on main branch)
  release-check:
    name: Release Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgtk-3-dev

    - name: Configure CMake for release
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_EXAMPLES=ON \
          -DBUILD_TESTS=ON

    - name: Build release version
      run: cmake --build build --config Release

    - name: Run release tests
      run: ctest --test-dir build --config Release --output-on-failure
